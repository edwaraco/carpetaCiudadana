# Luego de iniciar el cluster con los pasos de la guía completa...
# Resumidamente con
winget install -e --id Kubernetes.kubectl
winget install -e --id Kubernetes.minikube

# Esto en un PowerShell admin aparte
minikube start --driver=docker --memory=16384 --cpus=2
minikube addons enable metrics-server
minikube addons enable ingress
# Y vuelves.

# ========================================================================================================

# Ahora sí
# Vas a recompilar las imágenes Docker de los servicios locales
cd services/citizen-web; docker build -t citizen-web:latest .; cd ../..
cd services/auth-service; docker build -t auth-service:latest .; cd ../..
cd services/notifications-service; docker build -t notifications-service:latest .; cd ../..
cd services/carpeta-ciudadana-service; docker build -t carpeta-ciudadana-service:latest .; cd ../..
cd services/document-authentication-service; docker build -t document-authentication-service:latest .; cd ../..
cd services/ciudadano-registry-service; docker build -t ciudadano-registry-service:latest .; cd ../..

# Luego, cargas las imágenes en minikube
minikube image load auth-service:latest
minikube image load notifications-service:latest
minikube image load carpeta-ciudadana-service:latest
minikube image load document-authentication-service:latest
minikube image load citizen-web:latest
minikube image load ciudadano-registry-service:latest

# Despliegas cada servicio con kubectl. pero comienzas por RabbitMQ (y su operador)
kubectl apply -f https://github.com/rabbitmq/cluster-operator/releases/latest/download/cluster-operator.yml
cd services/rabbitmq-service; kubectl apply -f k8s/; cd ../..
cd services/auth-service; kubectl apply -f k8s/; cd ../..
cd services/notifications-service; kubectl apply -f k8s/; cd ../..
cd services/carpeta-ciudadana-service; kubectl apply -f k8s/; cd ../..
cd services/document-authentication-service; kubectl apply -f k8s/; cd ../..
cd services/citizen-web; kubectl apply -f k8s/; cd ../..
cd services/ciudadano-registry-service; kubectl apply -f k8s/; cd ../..


# =================================== TROUBLESHOOT =======================================

# Ver todos los pods
kubectl get pods -n carpeta-ciudadana

# Ver logs por app (ignora el nombre del pod)
kubectl logs -n carpeta-ciudadana -l app=carpeta-ciudadana-service --tail=50

# Ejecutar comando en el primer pod de una app
kubectl exec -n carpeta-ciudadana -l app=carpeta-ciudadana-service -it -- sh

# Ver pods organizados por app
kubectl get pods -n carpeta-ciudadana -L app

# Ver estado de replicación
kubectl get hpa -n carpeta-ciudadana

# Ver network policies
kubectl get svc -n carpeta-ciudadana
kubectl get networkpolicies -n carpeta-ciudadana
kubectl get ingress -n carpeta-ciudadana

# Cada que cambies el código de un servicio, recompila su imagen, cárgala en minikube, y haz un rollout restart
# Ejemplo para el servicio citizen-web:
cd services/citizen-web; docker build -t citizen-web:latest .; cd ../..
minikube image load citizen-web:latest
kubectl rollout restart deployment/citizen-web -n carpeta-ciudadana

# Si la imagen no se cambia, matamos al deployment (todos sus pods), borramos su imagen, volvemos a montar, y redeployamos
kubectl delete deployment citizen-web -n carpeta-ciudadana
minikube image rm docker.io/library/citizen-web:latest
minikube image load citizen-web:latest
cd services/citizen-web; kubectl apply -f k8s/01-deployment.yaml; cd ../..

# Si debes de cambiar alguna config de k8s, hazlo y luego aplica los cambios, y haz un rollout restart
cd services/carpeta-ciudadana-service; kubectl apply -f k8s/01-configmap.yaml; cd ../..
kubectl rollout restart deployment carpeta-ciudadana-service -n carpeta-ciudadana