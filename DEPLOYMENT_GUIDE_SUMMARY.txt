# Luego de iniciar el cluster con los pasos de la guía completa...
# Resumidamente con
winget install -e --id Kubernetes.kubectl
winget install -e --id Kubernetes.minikube

# Esto en un PowerShell admin aparte
minikube start --driver=docker --memory=16384 --cpus=2
minikube addons enable metrics-server
minikube addons enable ingress
# Y vuelves.

# ========================================================================================================

# Ahora sí
# Vas a recompilar las imágenes Docker de los servicios locales
cd services/citizen-web; docker build -t citizen-web:latest .; cd ../..
cd services/auth-service; docker build -t auth-service:latest .; cd ../..
cd services/notifications-service; docker build -t notifications-service:latest .; cd ../..
cd services/carpeta-ciudadana-service; docker build -t carpeta-ciudadana-service:latest .; cd ../..
cd services/document-authentication-service; docker build -t document-authentication-service:latest .; cd ../..
cd services/ciudadano-registry-service; docker build -t ciudadano-registry-service:latest .; cd ../..

# Luego, cargas las imágenes en minikube
minikube image load auth-service:latest
minikube image load notifications-service:latest
minikube image load carpeta-ciudadana-service:latest
minikube image load document-authentication-service:latest
minikube image load citizen-web:latest
minikube image load ciudadano-registry-service:latest

# Despliegas cada servicio con kubectl. pero comienzas por RabbitMQ (y su operador)
kubectl apply -f https://github.com/rabbitmq/cluster-operator/releases/latest/download/cluster-operator.yml
cd services/rabbitmq-service; kubectl apply -f k8s/; cd ../..
cd services/auth-service; kubectl apply -f k8s/; cd ../..
cd services/notifications-service; kubectl apply -f k8s/; cd ../..
cd services/carpeta-ciudadana-service; kubectl apply -f k8s/; cd ../..
cd services/document-authentication-service; kubectl apply -f k8s/; cd ../..
cd services/citizen-web; kubectl apply -f k8s/; cd ../..
cd services/ciudadano-registry-service; kubectl apply -f k8s/; cd ../..

# PORT-FORWARDS REQUERIDOS (MANTENER ESTOS TERMINALES ABIERTOS)
# Abre terminales separadas para cada servicio que quieras acceder:

# Terminal 1 - Frontend (REQUERIDO)
kubectl port-forward -n carpeta-ciudadana svc/citizen-web 8080:8080

# Terminal 2 - RabbitMQ Management UI (REQUERIDO para monitoreo)
kubectl port-forward -n carpeta-ciudadana svc/carpeta-rabbitmq 5672:5672 15672:15672

# Terminal 3 - MinIO Console (OPCIONAL - administración de archivos)
kubectl port-forward -n carpeta-ciudadana svc/minio-console 9001:9001

# Terminal 4 - MinIO API (OPCIONAL - operaciones S3)
kubectl port-forward -n carpeta-ciudadana svc/minio 9000:9000

# Terminal 5 - Carpeta Ciudadana API (OPCIONAL - Swagger UI)
kubectl port-forward -n carpeta-ciudadana svc/carpeta-ciudadana-service 8080:8080

# Terminal 6 - Document Authentication API (OPCIONAL - Swagger UI)
kubectl port-forward -n carpeta-ciudadana svc/document-authentication-service 8083:8083


# ======================================== ACCESO A LOS SERVICIOS ========================================
# Después de tener los port-forwards activos, accede desde tu navegador:

# INTERFAZ PRINCIPAL
# ------------------
# Frontend Web Application
http://localhost:8080
# Interfaz principal para ciudadanos (registro, login, gestión de documentos)


# INTERFACES DE ADMINISTRACIÓN
# -----------------------------
# RabbitMQ Management UI (credenciales: admin / admin123)
http://localhost:15672
# - Monitoreo de colas y mensajes
# - Gestión de exchanges y bindings
# - Estadísticas de rendimiento

# MinIO Console (credenciales: admin / admin123)
http://localhost:9001
# - Navegador de archivos S3
# - Gestión de buckets
# - Políticas de acceso
# - Monitoreo de uso

# Kubernetes Dashboard (OPCIONAL - requiere instalación adicional)
# kubectl proxy
# http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/
# http://localhost:8001/api/v1/namespaces/
# - Monitoreo de pods y deployments
# - Logs y eventos del cluster
# - Gestión de recursos


# APIS Y DOCUMENTACIÓN
# --------------------
# Carpeta Ciudadana Service - Swagger UI
http://localhost:8080/api/v1/swagger-ui.html
# Documentación interactiva de la API principal

# Document Authentication Service - API Docs
http://localhost:8083/api/v1/docs
# Documentación de la API de autenticación de documentos

# MinIO S3 API Endpoint
http://localhost:9000
# Endpoint para operaciones S3 programáticas



# =================================== VERIFICAR =======================================

# Ver todos los pods
kubectl get pods -n carpeta-ciudadana

# Ver logs por app (ignora el nombre del pod)
kubectl logs -n carpeta-ciudadana -l app=carpeta-ciudadana-service --tail=50

# Ejecutar comando en el primer pod de una app
kubectl exec -n carpeta-ciudadana -l app=carpeta-ciudadana-service -it -- sh

# Ver pods organizados por app
kubectl get pods -n carpeta-ciudadana -L app

# Ver estado de replicación
kubectl get hpa -n carpeta-ciudadana

# Ver network policies
kubectl get svc -n carpeta-ciudadana
kubectl get networkpolicies -n carpeta-ciudadana

# Ver eventos recientes del cluster (útil para debugging)
kubectl get events -n carpeta-ciudadana --sort-by='.lastTimestamp' | Select-Object -Last 20

# Ver descripción completa de un pod (para ver errores de scheduling, probes, etc)
kubectl describe pod <pod-name> -n carpeta-ciudadana

# Ver logs de múltiples pods de una app
kubectl logs -n carpeta-ciudadana -l app=auth-service --tail=50 --prefix

# Ver uso de recursos (CPU/Memoria) por pod
kubectl top pods -n carpeta-ciudadana

# Ver configuración de un ConfigMap
kubectl get configmap carpeta-ciudadana-config -n carpeta-ciudadana -o yaml

# Probar conectividad desde un pod a otro servicio
kubectl exec -n carpeta-ciudadana -l app=carpeta-ciudadana-service -it -- sh
# Dentro del pod:
# nc -zv minio 9000
# nc -zv carpeta-rabbitmq 5672
# wget -O- http://citizen-web:8080

# Ver el estado de rollout de un deployment
kubectl rollout status deployment/carpeta-ciudadana-service -n carpeta-ciudadana
kubectl rollout history deployment/carpeta-ciudadana-service -n carpeta-ciudadana

# Verificar health checks de RabbitMQ
kubectl exec -n carpeta-ciudadana carpeta-rabbitmq-server-0 -- rabbitmqctl cluster_status
kubectl exec -n carpeta-ciudadana carpeta-rabbitmq-server-0 -- rabbitmqctl list_queues

# =================================== TROUBLESHOOT =======================================

# Cada que cambies el código de un servicio, recompila su imagen, cárgala en minikube, y haz un rollout restart
# Ejemplo para el servicio citizen-web:
cd services/citizen-web; docker build -t citizen-web:latest .; cd ../..
minikube image load citizen-web:latest
kubectl rollout restart deployment/citizen-web -n carpeta-ciudadana

# Si la imagen no se cambia, matamos al deployment (todos sus pods), borramos su imagen, volvemos a montar, y redeployamos
kubectl delete deployment citizen-web -n carpeta-ciudadana
minikube image rm docker.io/library/citizen-web:latest
minikube image load citizen-web:latest
cd services/citizen-web; kubectl apply -f k8s/01-deployment.yaml; cd ../..

# Si debes de cambiar alguna config de k8s, hazlo y luego aplica los cambios, y haz un rollout restart
cd services/carpeta-ciudadana-service; kubectl apply -f k8s/01-configmap.yaml; cd ../..
kubectl rollout restart deployment carpeta-ciudadana-service -n carpeta-ciudadana