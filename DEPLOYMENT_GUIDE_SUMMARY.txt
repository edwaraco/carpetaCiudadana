# Luego de iniciar el cluster con los pasos de la guía completa...
# Resumidamente con
winget install -e --id Kubernetes.kubectl
winget install -e --id Kubernetes.minikube

# Esto en un PowerShell admin aparte
minikube start --driver=docker --memory=16384 --cpus=2
minikube addons enable metrics-server
minikube addons enable ingress
# Y vuelves.

# ========================================================================================================

# Ahora sí
# Vas a recompilar las imágenes Docker de los servicios locales
cd services/citizen-web; docker build -t citizen-web:latest .; cd ../..
cd services/auth-service; docker build -t auth-service:latest .; cd ../..
cd services/notifications-service; docker build -t notifications-service:latest .; cd ../..
cd services/carpeta-ciudadana-service; docker build -t carpeta-ciudadana-service:latest .; cd ../..
cd services/document-authentication-service; docker build -t document-authentication-service:latest .; cd ../..
cd services/ciudadano-registry-service; docker build -t ciudadano-registry-service:latest .; cd ../..

# Luego, cargas las imágenes en minikube
minikube image load auth-service:latest
minikube image load notifications-service:latest
minikube image load carpeta-ciudadana-service:latest
minikube image load document-authentication-service:latest
minikube image load citizen-web:latest
minikube image load ciudadano-registry-service:latest

# Despliegas cada servicio con kubectl. pero comienzas por RabbitMQ (y su operador)
kubectl apply -f https://github.com/rabbitmq/cluster-operator/releases/latest/download/cluster-operator.yml
cd services/rabbitmq-service; kubectl apply -f k8s/; cd ../..
cd services/auth-service; kubectl apply -f k8s/; cd ../..
cd services/notifications-service; kubectl apply -f k8s/; cd ../..
cd services/carpeta-ciudadana-service; kubectl apply -f k8s/; cd ../..
cd services/document-authentication-service; kubectl apply -f k8s/; cd ../..
cd services/citizen-web; kubectl apply -f k8s/; cd ../..
cd services/ciudadano-registry-service; kubectl apply -f k8s/; cd ../..

# ACTUALIZAR ARCHIVO HOSTS (NECESARIO PARA ACCEDER AL FRONTEND)
# En PowerShell como ADMINISTRADOR:
cd c:<idk>/carpetaCiudadana/tools
powershell -ExecutionPolicy Bypass -File update-minikube-hosts.ps1
# O doble click en el archivo tools/update-minikube-hosts.ps1
# O, bueno, corre su contraparte de linux
# Esto agregará "192.168.49.2 citizen-web.local" a tu archivo hosts


# INICIAR MINIKUBE TUNNEL (NECESARIO PARA INGRESS)
# En PowerShell como ADMINISTRADOR (abre OTRA ventana nueva y déjala abierta):
minikube tunnel
# IMPORTANTE: Esta ventana debe permanecer abierta mientras uses la aplicación
# El tunnel permite que el Ingress funcione en el puerto 80

# Ahora puedes acceder a la aplicación en: http://citizen-web.local





# =================================== VERIFICAR =======================================

# Ver todos los pods
kubectl get pods -n carpeta-ciudadana

# Ver logs por app (ignora el nombre del pod)
kubectl logs -n carpeta-ciudadana -l app=carpeta-ciudadana-service --tail=50

# Ejecutar comando en el primer pod de una app
kubectl exec -n carpeta-ciudadana -l app=carpeta-ciudadana-service -it -- sh

# Ver pods organizados por app
kubectl get pods -n carpeta-ciudadana -L app

# Ver estado de replicación
kubectl get hpa -n carpeta-ciudadana

# Ver network policies
kubectl get svc -n carpeta-ciudadana
kubectl get networkpolicies -n carpeta-ciudadana
kubectl get ingress -n carpeta-ciudadana

# Ver eventos recientes del cluster (útil para debugging)
kubectl get events -n carpeta-ciudadana --sort-by='.lastTimestamp' | Select-Object -Last 20

# Ver descripción completa de un pod (para ver errores de scheduling, probes, etc)
kubectl describe pod <pod-name> -n carpeta-ciudadana

# Ver logs de múltiples pods de una app
kubectl logs -n carpeta-ciudadana -l app=auth-service --tail=50 --prefix

# Ver uso de recursos (CPU/Memoria) por pod
kubectl top pods -n carpeta-ciudadana

# Ver configuración de un ConfigMap
kubectl get configmap carpeta-ciudadana-config -n carpeta-ciudadana -o yaml

# Verificar que el Ingress esté funcionando
kubectl get ingress -n carpeta-ciudadana
kubectl describe ingress citizen-web-ingress -n carpeta-ciudadana

# Probar conectividad desde un pod a otro servicio
kubectl exec -n carpeta-ciudadana -l app=carpeta-ciudadana-service -it -- sh
# Dentro del pod:
# nc -zv minio 9000
# nc -zv carpeta-rabbitmq 5672
# wget -O- http://citizen-web:8080

# Ver el estado de rollout de un deployment
kubectl rollout status deployment/carpeta-ciudadana-service -n carpeta-ciudadana
kubectl rollout history deployment/carpeta-ciudadana-service -n carpeta-ciudadana

# Verificar health checks de RabbitMQ
kubectl exec -n carpeta-ciudadana carpeta-rabbitmq-server-0 -- rabbitmqctl cluster_status
kubectl exec -n carpeta-ciudadana carpeta-rabbitmq-server-0 -- rabbitmqctl list_queues

# =================================== TROUBLESHOOT =======================================

# Cada que cambies el código de un servicio, recompila su imagen, cárgala en minikube, y haz un rollout restart
# Ejemplo para el servicio citizen-web:
cd services/citizen-web; docker build -t citizen-web:latest .; cd ../..
minikube image load citizen-web:latest
kubectl rollout restart deployment/citizen-web -n carpeta-ciudadana

# Si la imagen no se cambia, matamos al deployment (todos sus pods), borramos su imagen, volvemos a montar, y redeployamos
kubectl delete deployment citizen-web -n carpeta-ciudadana
minikube image rm docker.io/library/citizen-web:latest
minikube image load citizen-web:latest
cd services/citizen-web; kubectl apply -f k8s/01-deployment.yaml; cd ../..

# Si debes de cambiar alguna config de k8s, hazlo y luego aplica los cambios, y haz un rollout restart
cd services/carpeta-ciudadana-service; kubectl apply -f k8s/01-configmap.yaml; cd ../..
kubectl rollout restart deployment carpeta-ciudadana-service -n carpeta-ciudadana