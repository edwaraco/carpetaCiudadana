apiVersion: v1
kind: ConfigMap
metadata:
  name: auth-postgres-init
  namespace: carpeta-ciudadana
data:
  init.sql: |
    -- ðŸ—„ï¸ Database Initialization for Auth Service
    -- Creates minimal auth schema and table for user authentication

    -- Create auth schema
    CREATE SCHEMA IF NOT EXISTS auth;

    -- Users table for authentication (minimal auth data only)
        CREATE TABLE IF NOT EXISTS auth.users (
            citizen_id VARCHAR(50) PRIMARY KEY,      -- User's citizen ID (primary identifier)
            password_hash VARCHAR(255) NOT NULL,     -- bcrypt hashed password
            email_verified BOOLEAN DEFAULT TRUE,
            email VARCHAR(255) NOT NULL,               -- User email address
            created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
            CONSTRAINT valid_citizen_id CHECK (LENGTH(citizen_id) >= 6)
        );

        -- Insert a test user for development (password: "testpassword123")
        INSERT INTO auth.users (
            citizen_id,
            password_hash,
            email,
            email_verified
        ) VALUES (
            '123456',
            '$2a$10$35lpBIuHVvzkKCQqX/R3puLHaa7Urj3W69CTyPl4dlWp6CQSurYDq',  -- bcrypt hash of "testpassword123"
            'test@example.com',
            true
        ) ON CONFLICT (citizen_id) DO NOTHING;

        -- Log successful initialization
        DO $$
        BEGIN
            RAISE NOTICE 'Auth database schema initialized successfully';
            RAISE NOTICE 'Test user created: citizen_id=123456';
        END
        $$;

        -- Grant permissions
        GRANT USAGE ON SCHEMA auth TO auth_service_user;
        GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA auth TO auth_service_user;
        GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA auth TO auth_service_user;
        GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA auth TO auth_service_user;