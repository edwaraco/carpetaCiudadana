apiVersion: v1
kind: ConfigMap
metadata:
  name: auth-postgres-init
  namespace: carpeta-ciudadana
data:
  init.sql: |
    -- ðŸ—„ï¸ Database Initialization for Microservices
    -- Creates auth schema and tables for user authentication

    -- Create auth schema
    CREATE SCHEMA IF NOT EXISTS auth;

    -- Enable UUID extension
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

    -- Users table for authentication (minimal auth data only)
    CREATE TABLE IF NOT EXISTS auth.users (
        document_id VARCHAR(50) PRIMARY KEY,      -- User's document ID (primary identifier)
        password_hash VARCHAR(255) NOT NULL,     -- bcrypt hashed password
        
        -- Auth-related metadata only
        email_verified BOOLEAN DEFAULT TRUE,     -- Set to true when user completes registration
        is_active BOOLEAN DEFAULT TRUE,
        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        last_login TIMESTAMP WITH TIME ZONE,
        
        -- Constraints
        CONSTRAINT valid_document_id CHECK (LENGTH(document_id) >= 3)
    );

    -- Verification tokens table (for email validation)
    CREATE TABLE IF NOT EXISTS auth.verification_tokens (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        user_document_id VARCHAR(50) REFERENCES auth.users(document_id) ON DELETE CASCADE,
        token_hash VARCHAR(255) NOT NULL,         -- bcrypt hashed token
        token_type VARCHAR(20) NOT NULL,          -- 'email_verification', 'password_reset'
        expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
        used_at TIMESTAMP WITH TIME ZONE,
        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        
        -- Constraints
        CONSTRAINT valid_token_type CHECK (token_type IN ('email_verification', 'password_reset')),
        CONSTRAINT future_expiry CHECK (expires_at > created_at)
    );

    -- Sessions table (for JWT token management)
    CREATE TABLE IF NOT EXISTS auth.sessions (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        user_document_id VARCHAR(50) REFERENCES auth.users(document_id) ON DELETE CASCADE,
        token_hash VARCHAR(255) NOT NULL,         -- JWT token hash for revocation
        expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        last_used TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        is_revoked BOOLEAN DEFAULT FALSE,
        
        -- Metadata
        user_agent TEXT,
        ip_address INET,
        
        -- Constraints
        CONSTRAINT future_expiry CHECK (expires_at > created_at)
    );

    -- Create indexes for performance
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_verification_tokens_user_document_id 
        ON auth.verification_tokens(user_document_id);
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_verification_tokens_token_hash 
        ON auth.verification_tokens(token_hash);
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_verification_tokens_expires_at 
        ON auth.verification_tokens(expires_at) WHERE used_at IS NULL;

    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_sessions_user_document_id 
        ON auth.sessions(user_document_id);
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_sessions_token_hash 
        ON auth.sessions(token_hash);
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_sessions_expires_at 
        ON auth.sessions(expires_at) WHERE is_revoked = FALSE;

    -- User profiles table (stores detailed user information)
    CREATE TABLE IF NOT EXISTS auth.user_profiles (
        user_document_id VARCHAR(50) PRIMARY KEY REFERENCES auth.users(document_id) ON DELETE CASCADE,
        email VARCHAR(255) NOT NULL,
        full_name VARCHAR(255) NOT NULL,
        phone VARCHAR(50),
        address TEXT,
        document_type VARCHAR(10) DEFAULT 'cc',
        
        -- Metadata
        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
        
        -- Constraints
        CONSTRAINT valid_email CHECK (email ~* '^[A-Za-z0-9._%-]+@[A-Za-z0-9.-]+[.][A-Za-z]+$'),
        CONSTRAINT valid_full_name CHECK (LENGTH(full_name) >= 2),
        CONSTRAINT valid_document_type CHECK (document_type IN ('cc', 'ce', 'passport', 'other'))
    );

    -- Create indexes for user_profiles
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_user_profiles_email 
        ON auth.user_profiles(email);

    -- Function to update updated_at timestamp
    CREATE OR REPLACE FUNCTION auth.update_updated_at_column()
    RETURNS TRIGGER AS $$
    BEGIN
        NEW.updated_at = NOW();
        RETURN NEW;
    END;
    $$ language 'plpgsql';

    -- Create triggers for updated_at
    CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON auth.users
        FOR EACH ROW EXECUTE FUNCTION auth.update_updated_at_column();

    CREATE TRIGGER update_user_profiles_updated_at BEFORE UPDATE ON auth.user_profiles
        FOR EACH ROW EXECUTE FUNCTION auth.update_updated_at_column();

    -- Grant permissions
    GRANT USAGE ON SCHEMA auth TO auth_service_user;
    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA auth TO auth_service_user;
    GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA auth TO auth_service_user;
    GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA auth TO auth_service_user;