# This is MY deployment guide

this is a guide i did myself and it worked perfectly, so these are the steps I want to have in the final deployment somehow (but probably on linux)

## Install kubectl

```powershell
winget install -e --id Kubernetes.kubectl
kubectl version --client  # to check
```

## install a kubernetes cluster manager

### Option 1: Minikube (Recommended for development)

```powershell
# Powershell:

# Install Minikube
winget install -e --id Kubernetes.minikube

# Start Minikube cluster
## On an admin privileged Powershell shell (will make you restart)
Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V-Tools-All -All

## Start cluster. Make sure you have docker service running to pull images
minikube start --driver=hyperv --memory=6144 --cpus=2

# Verify cluster is running
kubectl cluster-info
kubectl get nodes
```

### Option 2: Docker Desktop Kubernetes

If you have Docker Desktop:

1. Open Docker Desktop
2. Go to Settings → Kubernetes
3. Enable "Enable Kubernetes"
4. Wait for cluster to start
5. Verify: `kubectl cluster-info`

## To have "make" available on Windows

This is for being able to use the multiple useful commands defined in the Makefile.

Restart your powershell terminal after each installation step.

- Install chocolatey package manager

```powershell
# on an admin privileged Powershell shell

Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
```

- Install make

```powershell
# on an admin privileged Powershell shell

choco install make
```

## Deploy RabbitMQ Cluster Operator

```powershell
# Install RabbitMQ Cluster Operator
kubectl apply -f https://github.com/rabbitmq/cluster-operator/releases/latest/download/cluster-operator.yml

# Verify installation
kubectl get pods -n rabbitmq-system
kubectl get customresourcedefinition | Select-String rabbitmq
```

## Deploy the RabbitMQ Cluster

```powershell
cd services/rabbitmq-service
kubectl apply -f k8s/
```

## Verify Deployment

```powershell
# Ver cluster
kubectl get rabbitmqclusters -n carpeta-ciudadana

# Ver pods (esperar hasta que estén 1/1 Running)
kubectl get pods -n carpeta-ciudadana -w

# Ver PVCs
kubectl get pvc -n carpeta-ciudadana

# Ver estado del cluster RabbitMQ
kubectl exec -n carpeta-ciudadana carpeta-rabbitmq-server-0 -- rabbitmqctl cluster_status
```

## Go to UI management

```powershell
# Port-forwarding, make sure to keep this terminal open
kubectl port-forward -n carpeta-ciudadana svc/carpeta-rabbitmq 5672:5672 15672:15672

# Open Management UI in browser
start http://localhost:15672
```

### Login Credentials

You have two options to access the RabbitMQ Management UI:

#### Option 1: Admin User (Recommended - Easier)

Use the admin user defined in the definitions file:

- **Username:** `admin`
- **Password:** `admin123`

This user is defined in `k8s/05-queue-definitions.yaml` and has full administrator access.

#### Option 2: Default User (Generated by Operator)

Extract the dynamically generated credentials from Kubernetes secret:

**Linux:**

```bash
export RABBITMQ_USER=$(kubectl get secret carpeta-rabbitmq-default-user -n carpeta-ciudadana -o jsonpath='{.data.username}' | base64 -d)
export RABBITMQ_PASSWORD=$(kubectl get secret carpeta-rabbitmq-default-user -n carpeta-ciudadana -o jsonpath='{.data.password}' | base64 -d)
echo "User: $RABBITMQ_USER"
echo "Password: $RABBITMQ_PASSWORD"
```

**Windows Powershell:**

```powershell
$RABBITMQ_USER = kubectl get secret carpeta-rabbitmq-default-user -n carpeta-ciudadana -o jsonpath='{.data.username}' | ForEach-Object { [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($_)) }
$RABBITMQ_PASSWORD = kubectl get secret carpeta-rabbitmq-default-user -n carpeta-ciudadana -o jsonpath='{.data.password}' | ForEach-Object { [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($_)) }
Write-Host "User: $RABBITMQ_USER"
Write-Host "Password: $RABBITMQ_PASSWORD"
```

### Verify Setup

```powershell
# List all users
kubectl exec -n carpeta-ciudadana carpeta-rabbitmq-server-0 -- rabbitmqctl list_users

# List all queues
kubectl exec -n carpeta-ciudadana carpeta-rabbitmq-server-0 -- rabbitmqctl list_queues name durable auto_delete

# List exchanges
kubectl exec -n carpeta-ciudadana carpeta-rabbitmq-server-0 -- rabbitmqctl list_exchanges name type durable
```

You should see:

- **Users:** `admin` and `default_user_XXXXX`
- **Queues:** `document_verification_request`, `document_verified_response`, `test_queue`, and their DLQ counterparts
- **Exchanges:** `carpeta.events` and `carpeta.dlx`

## Rollout after changing any k8s file

```powershell
kubectl apply -f k8s/
kubectl rollout restart statefulset/carpeta-rabbitmq-server -n carpeta-ciudadana

# Con esto verificas que terminó el rollout:
kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=carpeta-rabbitmq -n carpeta-ciudadana --timeout=300s
```

## KILL the deployment

```powershell
kubectl delete -f k8s/
```

## Troubleshooting

### Authentication Failed on Management UI

If you get "Authentication failed" when trying to log in:

1. **Check if users exist:**

   ```powershell
   kubectl exec -n carpeta-ciudadana carpeta-rabbitmq-server-0 -- rabbitmqctl list_users
   ```

2. **If no users appear**, the definitions file might have overridden them. The solution is to:
   - Define an admin user in `k8s/05-queue-definitions.yaml` (already done with `admin/admin123`)
   - Ensure the `load_definitions` configuration is present in `k8s/03-rabbitmq-cluster.yaml`
   - Restart the cluster:

     ```powershell
     kubectl rollout restart statefulset/carpeta-rabbitmq-server -n carpeta-ciudadana
     kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=carpeta-rabbitmq -n carpeta-ciudadana --timeout=300s
     ```

3. If user exists, it's defined on definitions.json, but the password doesn't match:
   - You can either change the password on runtime, export the definitions file, and update the hashed password of your local definition.

    ```powershell
    # Change password for the user. Admin used here as example
    kubectl exec -n carpeta-ciudadana carpeta-rabbitmq-server-0 -- rabbitmqctl change_password admin admin123

    # Give admin user administrator tag
    kubectl exec -n carpeta-ciudadana carpeta-rabbitmq-server-0 -- rabbitmqctl set_user_tags admin administrator
    
    # You will see the actual hash of the password here, on password_hash field
    $auth = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("admin:admin123")); Invoke-RestMethod -Uri "http://localhost:15672/api/users/admin" -Headers @{Authorization="Basic $auth"} | ConvertTo-Json
    ```

### Queues Not Created

If queues are missing:

1. Check that the ConfigMap is mounted and definitions are loaded in the cluster config
2. Verify the definitions ConfigMap:

   ```powershell
   kubectl get configmap rabbitmq-definitions -n carpeta-ciudadana -o yaml
   ```

3. Check RabbitMQ logs for import errors:

   ```powershell
   kubectl logs -n carpeta-ciudadana carpeta-rabbitmq-server-0 | Select-String "definition"
   ```

### Complete Reset (Nuclear Option)

If things are really broken, delete everything and start fresh:

```powershell
# Delete the entire cluster
kubectl delete -f services/rabbitmq-service/k8s/

# Wait a moment for cleanup
Start-Sleep -Seconds 10

# Redeploy
kubectl apply -f services/rabbitmq-service/k8s/

# Wait for pods to be ready
kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=carpeta-rabbitmq -n carpeta-ciudadana --timeout=300s
```
